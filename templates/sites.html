<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sites Map - North West England</title>
<link rel="icon" type="image/png" href="static/logos/servitech.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; }

/* Sidebar */
.sidebar {
    width: 220px;
    background-color: #2c3e50;
    color: #fff;
    min-height: 100vh;
    padding-top: 20px;
    position: fixed;
}
.sidebar a {
    display: block;
    color: #ecf0f1;
    padding: 12px 20px;
    text-decoration: none;
}
.sidebar a.active { background-color: #2980b9; }

/* Main content */
.main-content {
    margin-left: 220px;
    flex: 1;
    height: 100vh;
    position: relative;
}

/* Site dropdown */
#siteSelect {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1001;
    padding: 5px;
    border-radius: 4px;
    border: 1px solid #ccc;
    font-size: 14px;
}

/* Map */
#map { width: 100%; height: 100%; }

#siteModal {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255,255,255,0.96);
    border-radius: 8px;
    padding: 15px 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    width: 372px;
    max-height: 95vh; /* new: limit modal height to 80% of viewport */
    overflow-y: auto; /* new: allow vertical scroll */
    display: none;
    z-index: 1000;
}

#siteModal h2 { font-size: 18px; margin-bottom: 6px; }
#ownerInfo span { display: block; font-size: 14px; margin-bottom: 3px; }

/* Toggle button */
#toggleInstruments {
    margin: 10px 0;
    background: none;
    border: none;
    color: #2980b9;
    font-weight: 600;
    cursor: pointer;
    padding: 0;
}

/* Instruments list */
.instrument-list,
.nearby-list {
    margin-top: 8px;
}

.instrument-row,
.nearby-row {
    display: flex;
    justify-content: space-between;
    font-weight: 700;
    margin-bottom: 4px;
}

.instrument-row { color: #2980b9; }
.nearby-row { color: #e74c3c; }

.shared-instrument {
    color: #2980b9;
    font-weight: 600;
    margin-left: 12px;
    font-size: 13px;
}

#nearbyTitle {
    font-weight: 700;
    color: #e74c3c;
    font-size: 14px;
    text-transform: capitalize;
    margin-top: 24px; 
}

.no-shared-note {
    font-size: 12px;
    color: #000;
    margin-top: 6px;
}

.sidebar {
    display: flex;
    flex-direction: column;
    width: 220px;
    background-color: #2c3e50;
    color: #fff;
    min-height: 100vh;
    padding-top: 20px;
}

.sidebar-nav {
    display: flex;
    flex-direction: column;
    gap: 10px; /* optional spacing between links */
}

.sidebar-bottom {
    margin-top: auto; /* sticks to bottom */
    padding: 15px;
}


</style>
</head>

<body>

<div class="sidebar">
    <!-- Navigation links -->
    <div class="sidebar-nav">
        <a href="{{ url_for('index') }}" class="{% if request.path == '/' %}active{% endif %}" id="menu-jobs">Jobs</a>
        <a href="{{ url_for('instruments') }}" class="{% if request.path.startswith('/instruments') %}active{% endif %}" id="menu-instruments">Instruments</a>
        <a href="{{ url_for('sites') }}" class="{% if request.path.startswith('/sites') %}active{% endif %}" id="menu-sites">Sites</a>
    </div>

    <!-- Username at bottom -->
    <div class="sidebar-bottom">
        <div style="font-size:14px; color:#bdc3c7;">Logged in as:</div>
        <div style="font-size:42px; font-weight:bold; text-transform:uppercase; color:#ecf0f1;">
            {{ session['username'] }}
        </div>
    </div>
</div>


<div class="main-content">
    <!-- Site dropdown -->
    <select id="siteSelect">
        <option value="">Select a site</option>
    </select>

    <div id="map"></div>

    <div id="siteModal">
        <h2 id="modalSiteName"></h2>
        <div id="ownerInfo"></div>
        <button id="toggleInstruments">Show Instruments</button>
        <div id="instrumentSection" style="display:none;">
            <div class="instrument-list" id="instrumentList"></div>
        </div>
        <div id="nearbyTitle">Closest Sites</div>
        <div class="nearby-list" id="nearbySites"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const redIcon = L.icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
});

const map = L.map('map').setView([53.5, -2.5], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let siteMarkers = [];
let radiusCircle = null;
let nameLabels = [];
let showInstrumentsToggle = false;

function milesToMeters(m) { return m * 1609.34; }
function titleCase(str) { return str.toLowerCase().replace(/\b\w/g, l => l.toUpperCase()); }

async function showModal(site, nearbySites) {
    document.getElementById('modalSiteName').innerText = titleCase(site.name);
    const owner = document.getElementById('ownerInfo');
    owner.innerHTML = '';
    if(site.OwnerName) owner.innerHTML += `<span>${site.OwnerName}</span>`;
    if(site.OwnerPhone) owner.innerHTML += `<span>${site.OwnerPhone}</span>`;
    if(site.OwnerEmail) owner.innerHTML += `<span>${site.OwnerEmail}</span>`;

    const mainRes = await fetch(`/api/jobs/${site.id}`);
    const mainJobs = await mainRes.json();
    const mainSiteInstruments = new Set(mainJobs.map(j => titleCase(j.EAgIDesc || 'Unknown')));

    const instrumentList = document.getElementById('instrumentList');
    instrumentList.innerHTML = '';
    const counts = {};
    mainJobs.forEach(j => {
        const k = titleCase(j.EAgIDesc || 'Unknown');
        counts[k] = (counts[k] || 0) + 1;
    });
    Object.entries(counts).sort((a,b)=>b[1]-a[1])
        .forEach(([name,count])=>{
            instrumentList.innerHTML += `<div class="instrument-row"><span>${name}</span><span>${count}</span></div>`;
        });

    // Reset markers and labels
    siteMarkers.forEach(s=>s.marker.setIcon(new L.Icon.Default()));
    nameLabels.forEach(l => map.removeLayer(l));
    nameLabels = [];

    // Sort nearbySites by distance
    nearbySites.sort((a,b)=>{
        const distA = map.distance([site.Latitude, site.Longitude],[a.Latitude,a.Longitude]);
        const distB = map.distance([site.Latitude, site.Longitude],[b.Latitude,b.Longitude]);
        return distA - distB;
    });

    const nearbyList = document.getElementById('nearbySites');
    nearbyList.innerHTML = '';
    let anyShared = false;

    for (let s of nearbySites) {
        const dist = map.distance([site.Latitude, site.Longitude],[s.Latitude,s.Longitude])/1609.34;
        const distRounded = Math.round(dist*10)/10;

        const markerObj = siteMarkers.find(sm => sm.site === s);
        if(markerObj) {
            markerObj.marker.setIcon(redIcon);
            const label = L.marker([s.Latitude, s.Longitude], {
                icon: L.divIcon({
                    className: 'site-label',
                    html: `<span style="background:white;padding:2px 4px;border-radius:3px;font-size:12px;font-weight:600;">${titleCase(s.name)}</span>`,
                    iconSize: [100, 20],
                    iconAnchor: [50, 41]
                }),
                interactive: false
            }).addTo(map);
            nameLabels.push(label);
        }

        const nearbyRes = await fetch(`/api/jobs/${s.id}`);
        const nearbyJobs = await nearbyRes.json();
        const nearbyInstruments = new Set(nearbyJobs.map(j=>titleCase(j.EAgIDesc||'Unknown')));
        const shared = [...mainSiteInstruments].filter(i=>nearbyInstruments.has(i));

        const siteRow = document.createElement('div');
        siteRow.className='nearby-row';
        siteRow.innerHTML = `<span>${titleCase(s.name)} (${distRounded} miles)</span><span></span>`;
        nearbyList.appendChild(siteRow);

        shared.forEach(instr => {
            const instrDiv = document.createElement('div');
            instrDiv.className='shared-instrument';
            instrDiv.style.display = showInstrumentsToggle ? 'block' : 'none';
            instrDiv.innerText = instr;
            nearbyList.appendChild(instrDiv);
        });

        if(shared.length) anyShared = true;
    }

    if(!anyShared){
        const note = document.createElement('div');
        note.className='no-shared-note';
        note.innerText='There are no shared instruments at these sites';
        nearbyList.appendChild(note);
    }

    document.getElementById('siteModal').style.display='block';
}

document.getElementById('toggleInstruments').onclick=function(){
    showInstrumentsToggle = !showInstrumentsToggle;
    const sec=document.getElementById('instrumentSection');
    sec.style.display = showInstrumentsToggle ? 'block' : 'none';
    this.innerText = showInstrumentsToggle ? 'Hide Instruments' : 'Show Instruments';
    document.querySelectorAll('.shared-instrument').forEach(el => {
        el.style.display = showInstrumentsToggle ? 'block' : 'none';
    });
};

// Load sites
fetch('/api/sites/coords')
.then(r=>r.json())
.then(data=>{
    const siteSelect = document.getElementById('siteSelect');
    data.sort((a,b) => a.name.localeCompare(b.name)); // <-- sort alphabetically by site name
	data.forEach(site=>{
        if(!site.Latitude||!site.Longitude)return;
        const marker=L.marker([site.Latitude,site.Longitude]).addTo(map);
        marker.bindTooltip(site.name);
        siteMarkers.push({marker,site});

        // Add site to dropdown
        const option = document.createElement('option');
        option.value = site.id;
        option.textContent = titleCase(site.name);
        siteSelect.appendChild(option);

        marker.on('click', async ()=>{
            if(radiusCircle) map.removeLayer(radiusCircle);
            radiusCircle = L.circle([site.Latitude,site.Longitude],{radius:milesToMeters(3),color:'red',fill:false}).addTo(map);
            map.fitBounds(radiusCircle.getBounds(),{padding:[30,30]});

            const nearby = siteMarkers
                .filter(s2=>s2.site!==site && map.distance([site.Latitude,site.Longitude],[s2.site.Latitude,s2.site.Longitude])<=milesToMeters(3))
                .map(s2=>s2.site);

            await showModal(site, nearby);
        });
    });

    // Dropdown change
    siteSelect.addEventListener('change', async () => {
        const siteId = siteSelect.value;
        if(!siteId) return;
        const selected = siteMarkers.find(s => s.site.id == siteId);
        if(!selected) return;

        const site = selected.site;
        if(radiusCircle) map.removeLayer(radiusCircle);
        radiusCircle = L.circle([site.Latitude,site.Longitude],{radius:milesToMeters(3),color:'red',fill:false}).addTo(map);
        map.fitBounds(radiusCircle.getBounds(),{padding:[30,30]});

        const nearby = siteMarkers
            .filter(s2=>s2.site!==site && map.distance([site.Latitude,site.Longitude],[s2.site.Latitude,s2.site.Longitude])<=milesToMeters(3))
            .map(s2=>s2.site);

        await showModal(site, nearby);
    });
});

// Click map to reset
map.on('click', ()=>{
    if(radiusCircle) map.removeLayer(radiusCircle);
    document.getElementById('siteModal').style.display='none';
    siteMarkers.forEach(s=>s.marker.setIcon(new L.Icon.Default()));
    nameLabels.forEach(l => map.removeLayer(l));
    nameLabels = [];
});
</script>

</body>
</html>
